<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data-Insight-Team</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            min-height: 100vh;
            display: flex;
            flex-direction: row; /* æ”¹ä¸ºæ¨ªå‘å¸ƒå±€ */
        }

        /* ---------------- å·¦ä¾§ä¾§è¾¹æ  ---------------- */
        #sidebar {
            width: 260px; /* å±•å¼€å®½åº¦ */
            min-width: 60px; /* æ”¶ç¼©æœ€å°å®½åº¦ */
            background-color: white;
            color: #333;
            transition: width 0.3s ease;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
            border-right: 1px solid #e0e0e0;
        }

        #sidebar.collapsed {
            width: 60px; /* æ”¶ç¼©å®½åº¦ */
        }

        .sidebar-header {
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e0e0e0;
        }

        .sidebar-title {
            font-size: 18px;
            font-weight: bold;
            white-space: nowrap;
            opacity: 1;
            transition: opacity 0.3s ease;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        #sidebar.collapsed .sidebar-title {
            opacity: 0;
            width: 0;
        }

        .sidebar-toggle {
            width: 32px;
            height: 32px;
            background-color: transparent;
            border: 1px solid #e0e0e0;
            color: #666;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s ease;
            border-radius: 4px;
        }

        .sidebar-toggle:hover {
            background-color: #f8f9fa;
            color: #3498db;
            border-color: #3498db;
        }

        .sidebar-menu {
            padding: 16px 8px;
            flex: 1;
            max-height: calc(100vh - 80px); /* å‡å»headeré«˜åº¦ */
            overflow-y: auto;
        }

        /* åªæœ‰å½“æ–‡ä»¶å¤¹å†…å®¹è¿‡å¤šæ—¶æ‰æ˜¾ç¤ºæ»šåŠ¨æ¡ - å·²ç§»è‡³sidebar-menu */
        .folder-content {
            /* ä¸å†éœ€è¦overflow-yï¼Œè®©ä¸‹æ‹‰èœå•èƒ½æ­£å¸¸æ˜¾ç¤º */
        }

        .menu-item {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: background-color 0.2s;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .menu-item:hover {
            background-color: #f8f9fa;
        }

        .menu-item.active {
            background-color: #e3f2fd;
            color: #1976d2;
        }

        .menu-icon {
            font-size: 20px;
            width: 24px;
            text-align: center;
        }

        .menu-text {
            white-space: nowrap;
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        #sidebar.collapsed .menu-text {
            opacity: 0;
            width: 0;
        }

        /* å†å²å¯¹è¯åˆ—è¡¨æ ·å¼ */
        .history-list {
            margin: 8px 0;
            max-height: 300px;
            overflow-y: auto;
            transition: max-height 0.3s ease;
        }

        .history-list.collapsed {
            max-height: 0;
            overflow: hidden;
        }

        .history-item {
            padding: 8px 16px 8px 36px;
            cursor: pointer;
            font-size: 14px;
            color: #666;
            transition: background-color 0.2s;
            position: relative;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .history-item:hover {
            background-color: #f8f9fa;
        }

        .history-item.active {
            background-color: #e3f2fd;
            color: #1976d2;
        }

        /* å±•å¼€/æ”¶èµ·å›¾æ ‡æ ·å¼ */
        .menu-item.has-submenu {
            position: relative;
        }

        .menu-item.has-submenu::after {
            content: 'â–¼';
            position: absolute;
            right: 16px;
            font-size: 12px;
            transition: transform 0.3s ease;
        }

        .menu-item.has-submenu.expanded::after {
            transform: rotate(180deg);
        }

        /* å½“ä¾§è¾¹æ æ”¶ç¼©æ—¶éšè—å†å²å¯¹è¯åˆ—è¡¨ */
        #sidebar.collapsed .history-list {
            display: none;
        }

        /* å½“ä¾§è¾¹æ æ”¶ç¼©æ—¶éšè—æ–‡ä»¶å¤¹åˆ—è¡¨ */
        #sidebar.collapsed .folder-list {
            display: none;
        }

        /* å½“ä¾§è¾¹æ æ”¶ç¼©æ—¶éšè—å±•å¼€/æ”¶èµ·å›¾æ ‡ */
        #sidebar.collapsed .menu-item.has-submenu::after {
            display: none;
        }

        /* æ–‡ä»¶ä¸Šä¼ æŒ‰é’®æ ·å¼ */
        #input-container button:first-of-type {
            width: auto;
            height: auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        /* æ–‡ä»¶æ¶ˆæ¯æ ·å¼ */
        .message-file {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }

        .message-file-icon {
            font-size: 20px;
        }

        .message-file-info {
            flex: 1;
        }

        .message-file-name {
            font-weight: 500;
            margin-bottom: 2px;
        }

        .message-file-size {
            font-size: 12px;
            color: #6c757d;
        }

        .message-file-download {
            color: #007bff;
            cursor: pointer;
            font-size: 14px;
        }

        /* æ–‡ä»¶å¤¹å’Œæ–‡ä»¶çš„å±•å¼€/æ”¶èµ·æ ·å¼ */
        .folder-list {
            margin: 8px 0;
            transition: max-height 0.3s ease;
        }

        .folder-list.collapsed {
            max-height: 0;
            overflow: hidden;
        }

        .folder-item {
            padding: 8px 16px 8px 36px;
            cursor: pointer;
            font-size: 14px;
            color: #666;
            transition: background-color 0.2s;
            position: relative;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .folder-item::before {
            content: 'ğŸ“';
            position: absolute;
            left: 16px;
            font-size: 12px;
        }

        .folder-item:hover {
            background-color: #f8f9fa;
        }

        .folder-item.active {
            background-color: #e3f2fd;
            color: #1976d2;
        }

        /* ä¾§è¾¹æ æ–‡ä»¶é¡¹æ ·å¼ */
        .sidebar-file-item {
            padding: 8px 16px 8px 48px;
            cursor: pointer;
            font-size: 14px;
            color: #333;
            transition: background-color 0.2s;
            position: relative;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            border-bottom: 1px solid #f0f0f0;
        }

        .sidebar-file-item::before {
            content: 'ğŸ“„';
            position: absolute;
            left: 28px;
            font-size: 12px;
        }

        .sidebar-file-item:hover {
            background-color: #f8f9fa;
        }

        .sidebar-file-item .file-name {
            font-weight: 500;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sidebar-file-item .file-desc {
            font-size: 12px;
            color: #999;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* æ–‡ä»¶æ“ä½œåŒºåŸŸ */
        .sidebar-file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-info {
            flex: 1;
            overflow: hidden;
        }

        .file-actions {
            position: relative;
            display: flex;
            align-items: center;
        }

        .action-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 18px;
            color: #999;
            padding: 4px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
        }

        .action-btn:hover {
            background-color: #f0f0f0;
            color: #666;
        }

        .dots {
            font-size: 12px;
            line-height: 1;
        }

        /* æ–‡ä»¶ä¸‹æ‹‰èœå• */
        .file-menu {
            position: absolute;
            right: 0;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            min-width: 120px;
            z-index: 1000;
            display: none;
        }

        .file-menu.show {
            display: block;
        }

        .file-menu .menu-item {
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            color: #333;
            transition: background-color 0.2s;
        }

        .file-menu .menu-item:hover {
            background-color: #f8f9fa;
        }

        /* æ–‡ä»¶å¤¹ä¸Šä¼ æŒ‰é’®æ ·å¼ */
        .folder-upload-btn {
            padding: 8px 16px 8px 36px;
            cursor: pointer;
            font-size: 14px;
            color: #3498db;
            transition: background-color 0.2s;
            position: relative;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .folder-upload-btn::before {
            content: 'ğŸ“+';
            position: absolute;
            left: 16px;
            font-size: 12px;
        }

        .folder-upload-btn:hover {
            background-color: #f8f9fa;
        }

        /* ---------------- ä¸­é—´èŠå¤©å®¹å™¨ ---------------- */
        #chat-container {
            flex: 1; /* å æ»¡å‰©ä½™ç©ºé—´ */
            background-color: #fff;
            margin: 16px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            height: calc(100vh - 32px); /* å‡å»ä¸Šä¸‹è¾¹è· */
            overflow: hidden;
        }

        #messages {
            flex: 1;
            overflow-y: auto;
            border-bottom: 1px solid #ddd;
            margin: 0 16px;
            padding: 16px 0;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* æ¶ˆæ¯å®¹å™¨ï¼šå¤´åƒ+å†…å®¹ï¼ˆå•ä¸ªå®¹å™¨å¯¹åº”ä¸€æ¡å®Œæ•´æ¶ˆæ¯ï¼‰ */
        .message-wrapper {
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #fff;
            flex-shrink: 0;
        }

        /* ç”¨æˆ·æ¶ˆæ¯ï¼šå³å¯¹é½+å¤´åƒåœ¨å³ */
        .message-wrapper.user {
            margin-left: auto;
            flex-direction: row-reverse;
        }
        .message-wrapper.user .message-avatar {
            background-color: #007bff;
        }
        .message-wrapper.user .message-avatar::after {
            content: "U";
        }
        .message-wrapper.user .message {
            background-color: #007bff;
            color: #fff;
        }

        /* åŠ©æ‰‹æ¶ˆæ¯ï¼šå·¦å¯¹é½+å•ä¸ªå®¹å™¨æ‰¿è½½æ‰€æœ‰æµå¼å†…å®¹ */
        .message-wrapper.assistant {
            margin-right: auto;
        }
        .message-wrapper.assistant .message-avatar {
            background-color: #6c757d;
        }
        .message-wrapper.assistant .message-avatar::after {
            content: "A";
        }
        .message-wrapper.assistant .message {
            background-color: #f1f1f1;
            color: #333;
        }

        /* é”™è¯¯/ç³»ç»Ÿæ¶ˆæ¯ */
        .message-wrapper.error,
        .message-wrapper.system {
            justify-content: center;
        }
        .message-wrapper.error .message-avatar,
        .message-wrapper.system .message-avatar {
            display: none;
        }
        .message-wrapper.error .message {
            color: #721c24;
            background-color: #d1ecf1;
            border: 1px solid #f5c6cb;
            max-width: 100%;
        }
        .message-wrapper.system .message {
            color: #0c5460;
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            max-width: 100%;
            text-align: center;
        }

        /* æ¶ˆæ¯å†…å®¹ï¼šç»Ÿä¸€æ ·å¼ */
        .message {
            padding: 8px 12px;
            border-radius: 6px;
            max-width: 80%;
            word-wrap: break-word;
        }

        #input-container {
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        #input-container input:disabled,
        #input-container button:disabled {
            background-color: #e0e0e0;
            cursor: not-allowed;
            opacity: 0.7;
        }

        #input-container input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            height: 44px;
            box-sizing: border-box;
        }

        #input-container button {
            padding: 12px 24px;
            border: 1px solid #e0e0e0;
            background-color: white;
            color: #666;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            height: 44px;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #input-container button:hover:not(:disabled) {
            background-color: #f8f9fa;
            border-color: #3498db;
            color: #3498db;
        }

        /* è¾“å…¥æ¡†æŒ‰é’®æ ·å¼ - ç™½è‰²ç®€çº¦é£æ ¼ */
        .input-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            border: 1px solid #e0e0e0;
            background-color: white;
            color: #666;
        }

        .input-btn:hover:not(:disabled) {
            background-color: #f8f9fa;
            border-color: #3498db;
            color: #3498db;
        }

        /* æ¸…ç©ºæŒ‰é’® */
        .clear-btn {
            padding: 12px 16px;
            font-size: 14px;
            border-radius: 6px;
            height: 44px;
            box-sizing: border-box;
        }

        /* ä¸Šä¼ æŒ‰é’® */
        .upload-btn {
            width: 44px;
            height: 44px;
            border-radius: 6px;
            font-size: 20px;
            font-weight: bold;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        /* å‘é€æŒ‰é’® */
        .send-btn {
            width: 44px;
            height: 44px;
            border-radius: 6px;
            font-size: 20px;
            font-weight: bold;
            line-height: 1;
            background-color: #007bff;
            color: white;
            border-color: #007bff;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            /* ç¡®ä¿æŒ‰é’®å†…å®¹å¯è§ */
            overflow: visible !important;
            text-indent: 0 !important;
        }

        .send-btn:hover {
            background-color: #0056b3;
            border-color: #0056b3;
            color: white;
        }



        /* ---------------- å³ä¾§æ–‡ä»¶ç»“æœæ  ---------------- */
        #file-result-panel {
            width: 320px;
            min-width: 280px;
            background-color: #fff;
            margin: 16px 16px 16px 0;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            height: calc(100vh - 32px);
            overflow: hidden;
        }

        .panel-header {
            padding: 16px;
            border-bottom: 1px solid #ddd;
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }

        .panel-content {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
        }

        .file-item {
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #eee;
            margin-bottom: 8px;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .file-item:hover {
            border-color: #007bff;
        }

        .file-name {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .file-desc {
            font-size: 12px;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
</head>

<body>
    <!-- å·¦ä¾§ä¾§è¾¹æ  -->
    <div id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">ğŸ–Œï¸ Data-Insight-Team</div>
            <button class="sidebar-toggle" id="sidebarToggle">â‰¡</button>
        </div>
        <div class="sidebar-menu">
            <!-- æ–°å¢å¯¹è¯ -->
            <div class="menu-item" id="newChatItem">
                <div class="menu-icon">âœš</div>
                <div class="menu-text">æ–°å¢å¯¹è¯</div>
            </div>
            <!-- å†å²å¯¹è¯ -->
            <div class="menu-item has-submenu" id="historyChatItem">
                <div class="menu-icon">ğŸ“œ</div>
                <div class="menu-text">å†å²å¯¹è¯</div>
            </div>
            <div class="history-list collapsed" id="historyList"></div>
            <!-- æ–‡ä»¶ -->
            <div class="menu-item has-submenu" id="filesItem">
                <div class="menu-icon">ğŸ“</div>
                <div class="menu-text">æ–‡ä»¶</div>
            </div>
            <div class="folder-list folder-content collapsed" id="filesList"></div>
            <!-- åˆ†æç»“æœ -->
            <div class="menu-item has-submenu" id="analysisResultsItem">
                <div class="menu-icon">ğŸ“Š</div>
                <div class="menu-text">åˆ†æç»“æœ</div>
            </div>
            <div class="folder-list folder-content collapsed" id="analysisResultsList"></div>
        </div>
    </div>

    <!-- ä¸­é—´èŠå¤©å®¹å™¨ -->
    <div id="chat-container">
        <div id="messages"></div>
        <div id="input-container">
            <div id="file-preview" style="width: 100%; margin-bottom: 8px; display: none;">
                <div id="preview-files" style="display: flex; gap: 12px; flex-wrap: wrap;"></div>
            </div>
            <div class="input-wrapper" style="display: flex; flex-direction: column; border: 1px solid #ddd; border-radius: 6px; padding: 0; overflow: hidden;">
                <!-- æ–‡å­—è¾“å…¥åŒºåŸŸ -->
                <div style="padding: 0;">
                    <input type="text" id="message-input" placeholder="Type a message..." style="width: 100%; border: none; padding: 12px 16px; height: 44px; box-sizing: border-box; outline: none;">
                </div>
                <!-- æŒ‰é’®åŒºåŸŸ -->
                <div style="display: flex; align-items: center; height: 44px; padding: 4px;">
                    <button onclick="clearChatHistory()" class="input-btn clear-btn" title="æ¸…ç©ºèŠå¤©è®°å½•" style="margin: 0 8px 0 0; border-radius: 4px; border: 1px solid #ddd; height: calc(100% - 8px);">ğŸ—‘ï¸</button>
                    <button onclick="document.getElementById('file-input').click()" class="input-btn upload-btn" title="ä¸Šä¼ æ–‡ä»¶" style="margin: 0; border-radius: 4px; border: 1px solid #ddd; height: calc(100% - 8px);">+</button>
                    <input type="file" id="file-input" style="display: none;" accept="*/*" onchange="uploadFile(this.files)">
                    <div style="flex: 1;"></div>
                    <button id="send-button" onclick="sendMessage()" class="input-btn send-btn" title="å‘é€" style="margin: 0; border-radius: 4px; border: 1px solid #ddd; height: calc(100% - 8px);">â†‘</button>
                </div>
            </div>
        </div>
    </div>

    <!-- å³ä¾§æ–‡ä»¶ç»“æœæ  -->
    <div id="file-result-panel">
        <div class="panel-header">æ–‡ä»¶ç»“æœ</div>
        <div class="panel-content" id="fileContent">
            <div style="text-align: center; color: #999; padding: 40px 0;">
                <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“</div>
                <div style="margin-bottom: 8px;">è¯·ç‚¹å‡»å·¦ä¾§æ–‡ä»¶å¤¹æŸ¥çœ‹æ–‡ä»¶</div>
                <div>é€‰æ‹©æ–‡ä»¶åå°†åœ¨æ­¤å¤„é¢„è§ˆå†…å®¹</div>
            </div>
        </div>
    </div>

    <script>
        const messagesContainer = document.getElementById('messages');
        let currentAssistantMessage = null; // å•ä¸ªåŠ©æ‰‹æ¶ˆæ¯å®¹å™¨ï¼ˆå«å¤´åƒ+å†…å®¹ï¼‰
        let currentConversationId = null; // å½“å‰å¯¹è¯IDï¼ˆæ–°å¢å¯¹è¯æ—¶ç”Ÿæˆ/è·å–ï¼‰
        let pendingFiles = []; // å¾…å‘é€çš„æ–‡ä»¶åˆ—è¡¨

        // ä¾§è¾¹æ å±•å¼€/æ”¶ç¼©é€»è¾‘
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebarToggle');
        let isCollapsed = false;
        sidebarToggle.addEventListener('click', () => {
            isCollapsed = !isCollapsed;
            sidebar.classList.toggle('collapsed', isCollapsed);
            sidebarToggle.textContent = isCollapsed ? 'â–¶' : 'â—€';
        });

        // ---------------- ä¾§è¾¹æ èœå•æ¥å£è¯·æ±‚é€»è¾‘ ----------------
        // 1. æ–°å¢å¯¹è¯
        const newChatItem = document.getElementById('newChatItem');
        newChatItem.addEventListener('click', async () => {
            try {
                // è°ƒç”¨æ–°å¢å¯¹è¯æ¥å£
                const response = await fetch('http://localhost:8000/new-conversation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) throw new Error(`æ–°å¢å¯¹è¯å¤±è´¥ï¼š${response.status}`);

                const result = await response.json();
                currentConversationId = result.conversationId; // ä¿å­˜æ–°å¯¹è¯ID
                saveConversationId(currentConversationId); // æŒä¹…åŒ–åˆ°localStorage

                // æ¸…ç©ºå½“å‰èŠå¤©è®°å½•ï¼Œæ˜¾ç¤ºç³»ç»Ÿæç¤º
                messagesContainer.innerHTML = '';
                createMessage(`å·²åˆ›å»ºæ–°å¯¹è¯ï¼ˆIDï¼š${currentConversationId}ï¼‰`, 'system');

                // æ¿€æ´»èœå•æ ·å¼
                setActiveMenuItem(newChatItem);

                console.log('æ–°å¢å¯¹è¯æˆåŠŸ', result);
            } catch (error) {
                console.error('æ–°å¢å¯¹è¯æ¥å£è¯·æ±‚å¤±è´¥', error);
                createMessage(`æ–°å¢å¯¹è¯å¤±è´¥ï¼š${error.message}`, 'error');
            }
        });

        // 2. å†å²å¯¹è¯
        const historyChatItem = document.getElementById('historyChatItem');
        const historyList = document.getElementById('historyList');

        historyChatItem.addEventListener('click', async () => {
            // åˆ‡æ¢å±•å¼€/æ”¶èµ·çŠ¶æ€
            historyChatItem.classList.toggle('expanded');
            historyList.classList.toggle('collapsed');

            // å¦‚æœæ˜¯å±•å¼€çŠ¶æ€ï¼Œè·å–å†å²å¯¹è¯åˆ—è¡¨
            if (!historyList.classList.contains('collapsed')) {
                try {
                    // è°ƒç”¨å†å²å¯¹è¯åˆ—è¡¨æ¥å£
                    const response = await fetch('http://localhost:8000/history-conversations', {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) throw new Error(`è·å–å†å²å¯¹è¯å¤±è´¥ï¼š${response.status}`);

                    const historyConversations = await response.json();

                    // æ¸…ç©ºå†å²å¯¹è¯åˆ—è¡¨
                    historyList.innerHTML = '';

                    // åˆ›å»ºå…¨å±€å¯¹è¯èœå•å®¹å™¨ï¼ˆPortalï¼‰
                    if (!document.getElementById('global-conversation-menu')) {
                        const globalMenuContainer = document.createElement('div');
                        globalMenuContainer.id = 'global-conversation-menu';
                        globalMenuContainer.className = 'file-menu';
                        globalMenuContainer.innerHTML = `<div class="menu-item" onclick="deleteConversationFromMenu()">åˆ é™¤</div>`;
                        document.body.appendChild(globalMenuContainer);
                    }

                    // æ¸²æŸ“å†å²å¯¹è¯åˆ—è¡¨åˆ°ä¾§è¾¹æ 
                    historyConversations.forEach((conv, index) => {
                        const historyItemContainer = document.createElement('div');
                        historyItemContainer.style.display = 'flex';
                        historyItemContainer.style.alignItems = 'center';

                        const historyItem = document.createElement('div');
                        historyItem.className = `history-item ${currentConversationId === conv.conversationId ? 'active' : ''}`;
                        historyItem.textContent = `å¯¹è¯ ${index + 1}`;
                        historyItem.dataset.conversationId = conv.conversationId;
                        historyItem.style.flex = '1';

                        // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼ŒåŠ è½½å¯¹åº”å¯¹è¯çš„å†å²è®°å½•
                        historyItem.addEventListener('click', () => {
                            loadConversationHistory(conv.conversationId);
                        });

                        // æ·»åŠ å¯¹è¯æ“ä½œæŒ‰é’®ï¼ˆä¸‰ä¸ªç‚¹ï¼‰
                        const conversationActions = document.createElement('div');
                        conversationActions.className = 'file-actions';
                        conversationActions.innerHTML = `
                            <button class="action-btn" onclick="toggleConversationMenu(event, this, '${conv.conversationId}')">
                                <span class="dots">â€¢â€¢â€¢</span>
                            </button>
                        `;

                        historyItemContainer.appendChild(historyItem);
                        historyItemContainer.appendChild(conversationActions);
                        historyList.appendChild(historyItemContainer);
                    });

                    console.log('è·å–å†å²å¯¹è¯æˆåŠŸ', historyConversations);
                } catch (error) {
                    console.error('å†å²å¯¹è¯æ¥å£è¯·æ±‚å¤±è´¥', error);
                    createMessage(`è·å–å†å²å¯¹è¯å¤±è´¥ï¼š${error.message}`, 'error');
                }
            }
        });

        // 3. æ–‡ä»¶
        const filesItem = document.getElementById('filesItem');
        const filesList = document.getElementById('filesList');

        filesItem.addEventListener('click', async () => {
            // åˆ‡æ¢å±•å¼€/æ”¶èµ·çŠ¶æ€
            filesItem.classList.toggle('expanded');
            filesList.classList.toggle('collapsed');

            // å¦‚æœæ˜¯å±•å¼€çŠ¶æ€ï¼Œè·å–æ–‡ä»¶åˆ—è¡¨
            if (!filesList.classList.contains('collapsed')) {
                try {
                    // é»˜è®¤ä½¿ç”¨"æ‰€æœ‰æ–‡ä»¶"æ–‡ä»¶å¤¹
                    const defaultFolder = "æ‰€æœ‰æ–‡ä»¶";
                    // è°ƒç”¨æ–‡ä»¶å¤¹ä¸‹æ–‡ä»¶åˆ—è¡¨æ¥å£
                    const response = await fetch(`http://localhost:8000/files/${defaultFolder}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) throw new Error(`è·å–æ–‡ä»¶å¤±è´¥ï¼š${response.status}`);

                    const files = await response.json();

                    // æ¸…ç©ºæ–‡ä»¶åˆ—è¡¨
                    filesList.innerHTML = '';

                    // å…ˆæ·»åŠ ä¸Šä¼ æ–‡ä»¶æŒ‰é’®åˆ°ä¾§è¾¹æ æ–‡ä»¶åˆ—è¡¨çš„é¡¶éƒ¨
                    const uploadButton = document.createElement('div');
                    uploadButton.className = 'folder-upload-btn';
                    uploadButton.textContent = 'ä¸Šä¼ æ–‡ä»¶';
                    uploadButton.addEventListener('click', () => {
                        // ç›´æ¥ä¸Šä¼ æ–‡ä»¶åˆ°é»˜è®¤æ–‡ä»¶å¤¹
                        uploadFileToDefaultFolder();
                    });

                    filesList.appendChild(uploadButton);

                    // ç„¶åæ¸²æŸ“æ–‡ä»¶åˆ—è¡¨åˆ°ä¾§è¾¹æ 
                    files.forEach((file, index) => {
                        const fileElement = document.createElement('div');
                        fileElement.className = 'sidebar-file-item';
                        fileElement.innerHTML = `
                            <div class="file-info">
                                <div class="file-name">${file.name}</div>
                                <div class="file-desc">å¤§å°ï¼š${file.size}</div>
                            </div>
                            <div class="file-actions">
                                <button class="action-btn" onclick="toggleFileMenu(event, this, '${file.name}')">
                                    <span class="dots">â€¢â€¢â€¢</span>
                                </button>
                            </div>
                        `;
                        fileElement.dataset.fileName = file.name;

                        // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œé¢„è§ˆæ–‡ä»¶
                        fileElement.querySelector('.file-info').addEventListener('click', () => {
                            previewFile(file.name);
                        });

                        filesList.appendChild(fileElement);
                    });

                    // åˆ›å»ºå…¨å±€ä¸‹æ‹‰èœå•å®¹å™¨ï¼ˆPortalï¼‰
                    if (!document.getElementById('global-file-menu')) {
                        const globalMenuContainer = document.createElement('div');
                        globalMenuContainer.id = 'global-file-menu';
                        globalMenuContainer.className = 'file-menu';
                        globalMenuContainer.innerHTML = `<div class="menu-item" onclick="downloadFileFromMenu()">ä¸‹è½½</div>`;
                        document.body.appendChild(globalMenuContainer);
                    }

                    // åˆ›å»ºå…¨å±€å¯¹è¯èœå•å®¹å™¨ï¼ˆPortalï¼‰
                    if (!document.getElementById('global-conversation-menu')) {
                        const globalMenuContainer = document.createElement('div');
                        globalMenuContainer.id = 'global-conversation-menu';
                        globalMenuContainer.className = 'file-menu';
                        globalMenuContainer.innerHTML = `<div class="menu-item" onclick="deleteConversationFromMenu()">åˆ é™¤</div>`;
                        document.body.appendChild(globalMenuContainer);
                    }

                    console.log('è·å–æ–‡ä»¶æˆåŠŸ', files);
                } catch (error) {
                    console.error('æ–‡ä»¶æ¥å£è¯·æ±‚å¤±è´¥', error);
                    createMessage(`è·å–æ–‡ä»¶å¤±è´¥ï¼š${error.message}`, 'error');
                }
            }
        });

        // 4. åˆ†æç»“æœ
        const analysisResultsItem = document.getElementById('analysisResultsItem');
        const analysisResultsList = document.getElementById('analysisResultsList');

        analysisResultsItem.addEventListener('click', async () => {
            // åˆ‡æ¢å±•å¼€/æ”¶èµ·çŠ¶æ€
            analysisResultsItem.classList.toggle('expanded');
            analysisResultsList.classList.toggle('collapsed');

            // å¦‚æœæ˜¯å±•å¼€çŠ¶æ€ï¼Œè·å–åˆ†æç»“æœåˆ—è¡¨
            if (!analysisResultsList.classList.contains('collapsed')) {
                try {
                    // ä½¿ç”¨"åˆ†æç»“æœ"æ–‡ä»¶å¤¹
                    const resultFolder = "åˆ†æç»“æœ";
                    // è°ƒç”¨æ–‡ä»¶å¤¹ä¸‹æ–‡ä»¶åˆ—è¡¨æ¥å£
                    const response = await fetch(`http://localhost:8000/files/${resultFolder}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) throw new Error(`è·å–åˆ†æç»“æœå¤±è´¥ï¼š${response.status}`);

                    const files = await response.json();

                    // æ¸…ç©ºç»“æœåˆ—è¡¨
                    analysisResultsList.innerHTML = '';

                    // æ¸²æŸ“ç»“æœåˆ—è¡¨åˆ°ä¾§è¾¹æ 
                    files.forEach((file, index) => {
                        const fileElement = document.createElement('div');
                        fileElement.className = 'sidebar-file-item';
                        fileElement.innerHTML = `
                            <div class="file-info">
                                <div class="file-name">${file.name}</div>
                                <div class="file-desc">å¤§å°ï¼š${file.size}</div>
                            </div>
                            <div class="file-actions">
                                <button class="action-btn" onclick="toggleFileMenu(event, this, '${file.name}')">
                                    <span class="dots">â€¢â€¢â€¢</span>
                                </button>
                            </div>
                        `;
                        fileElement.dataset.fileName = file.name;

                        // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œé¢„è§ˆæ–‡ä»¶
                        fileElement.querySelector('.file-info').addEventListener('click', () => {
                            previewFile(file.name);
                        });

                        analysisResultsList.appendChild(fileElement);
                    });

                    console.log('è·å–åˆ†æç»“æœæˆåŠŸ', files);
                } catch (error) {
                    console.error('åˆ†æç»“æœæ¥å£è¯·æ±‚å¤±è´¥', error);
                    createMessage(`è·å–åˆ†æç»“æœå¤±è´¥ï¼š${error.message}`, 'error');
                }
            }
        });

        // è¾…åŠ©å‡½æ•°ï¼šè®¾ç½®èœå•æ¿€æ´»æ ·å¼
        function setActiveMenuItem(activeItem) {
            // ç§»é™¤æ‰€æœ‰èœå•çš„æ¿€æ´»æ ·å¼
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            // æ·»åŠ å½“å‰èœå•çš„æ¿€æ´»æ ·å¼
            activeItem.classList.add('active');
        }

        // ç›´æ¥ä¸Šä¼ æ–‡ä»¶åˆ°é»˜è®¤æ–‡ä»¶å¤¹
        function uploadFileToDefaultFolder() {
            // ç›´æ¥ä¸Šä¼ åˆ°é»˜è®¤æ–‡ä»¶å¤¹"æ‰€æœ‰æ–‡ä»¶"
            uploadFileToFolder('æ‰€æœ‰æ–‡ä»¶');
        }

        // åŠ è½½æ–‡ä»¶å¤¹ä¸‹çš„æ–‡ä»¶åˆ—è¡¨
        async function loadFolderFiles(folderName) {
            try {
                // è°ƒç”¨æ–‡ä»¶å¤¹ä¸‹æ–‡ä»¶åˆ—è¡¨æ¥å£
                const response = await fetch(`http://localhost:8000/files/${folderName}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) throw new Error(`è·å–æ–‡ä»¶å¤¹ä¸‹æ–‡ä»¶å¤±è´¥ï¼š${response.status}`);

                const files = await response.json();

                // æ›´æ–°å³ä¾§æ–‡ä»¶ç»“æœæ 
                const fileContent = document.getElementById('fileContent');
                fileContent.innerHTML = `
                    ${files.map(file => `
                        <div class="file-item" onclick="previewFile('${file.name}')">
                            <div class="file-name">${file.name}</div>
                            <div class="file-desc">å¤§å°ï¼š${file.size} | åˆ›å»ºæ—¶é—´ï¼š${file.createTime}</div>
                        </div>
                    `).join('')}
                `;

                console.log('è·å–æ–‡ä»¶å¤¹ä¸‹æ–‡ä»¶æˆåŠŸ', files);
            } catch (error) {
                console.error('è·å–æ–‡ä»¶å¤¹ä¸‹æ–‡ä»¶å¤±è´¥ï¼š', error);
                createMessage(`è·å–æ–‡ä»¶å¤¹ä¸‹æ–‡ä»¶å¤±è´¥ï¼š${error.message}`, 'error');
            }
        }

        // å‘ç‰¹å®šæ–‡ä»¶å¤¹ä¸Šä¼ æ–‡ä»¶
        async function uploadFileToFolder(folderName, file = null) {
            // å¦‚æœæ²¡æœ‰æä¾›æ–‡ä»¶å¯¹è±¡ï¼Œåˆ™åˆ›å»ºæ–‡ä»¶è¾“å…¥æ¡†è®©ç”¨æˆ·é€‰æ‹©
            if (!file) {
                // åˆ›å»ºéšè—çš„æ–‡ä»¶è¾“å…¥æ¡†
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '*/*';
                fileInput.style.display = 'none';

                // æ·»åŠ æ–‡ä»¶é€‰æ‹©äº‹ä»¶
                fileInput.addEventListener('change', async (e) => {
                    if (!e.target.files || e.target.files.length === 0) return;

                    const selectedFile = e.target.files[0];
                    await uploadFileToFolder(folderName, selectedFile);

                    // ç§»é™¤ä¸´æ—¶æ–‡ä»¶è¾“å…¥æ¡†
                    fileInput.remove();
                });

                // æ·»åŠ åˆ°DOMå¹¶æ¨¡æ‹Ÿç‚¹å‡»
                document.body.appendChild(fileInput);
                fileInput.click();
                return;
            }

            // å¦‚æœæä¾›äº†æ–‡ä»¶å¯¹è±¡ï¼Œåˆ™ç›´æ¥ä¸Šä¼ 
            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('folderName', folderName);

                // å‘é€æ–‡ä»¶ä¸Šä¼ è¯·æ±‚
                const response = await fetch('http://localhost:8000/upload', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼š${response.status}`);
                }

                const result = await response.json();

                // ä¸Šä¼ æˆåŠŸåé‡æ–°åŠ è½½æ–‡ä»¶å¤¹å†…å®¹
                await loadFolderFiles(folderName);

                // å¦‚æœä¾§è¾¹æ æ˜¯å±•å¼€çŠ¶æ€ï¼Œé‡æ–°æ¸²æŸ“ä¾§è¾¹æ çš„æ–‡ä»¶åˆ—è¡¨
                if (folderName === "æ‰€æœ‰æ–‡ä»¶" && !filesList.classList.contains('collapsed')) {
                    // é‡æ–°æ¸²æŸ“"æ‰€æœ‰æ–‡ä»¶"ä¾§è¾¹æ åˆ—è¡¨
                    try {
                        const response = await fetch(`http://localhost:8000/files/${folderName}`, {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });

                        if (!response.ok) throw new Error(`è·å–æ–‡ä»¶å¤±è´¥ï¼š${response.status}`);

                        const files = await response.json();

                        // æ¸…ç©ºæ–‡ä»¶åˆ—è¡¨
                        filesList.innerHTML = '';

                        // å…ˆæ·»åŠ ä¸Šä¼ æ–‡ä»¶æŒ‰é’®åˆ°ä¾§è¾¹æ æ–‡ä»¶åˆ—è¡¨çš„é¡¶éƒ¨
                        const uploadButton = document.createElement('div');
                        uploadButton.className = 'folder-upload-btn';
                        uploadButton.textContent = 'ä¸Šä¼ æ–‡ä»¶';
                        uploadButton.addEventListener('click', () => {
                            // ç›´æ¥ä¸Šä¼ æ–‡ä»¶åˆ°é»˜è®¤æ–‡ä»¶å¤¹
                            uploadFileToDefaultFolder();
                        });

                        filesList.appendChild(uploadButton);

                        // ç„¶åæ¸²æŸ“æ–‡ä»¶åˆ—è¡¨åˆ°ä¾§è¾¹æ 
                        files.forEach((file, index) => {
                            const fileElement = document.createElement('div');
                            fileElement.className = 'sidebar-file-item';
                            fileElement.innerHTML = `
                                <div class="file-info">
                                    <div class="file-name">${file.name}</div>
                                    <div class="file-desc">å¤§å°ï¼š${file.size}</div>
                                </div>
                                <div class="file-actions">
                                    <button class="action-btn" onclick="toggleFileMenu(event, this, '${file.name}')">
                                        <span class="dots">â€¢â€¢â€¢</span>
                                    </button>
                                </div>
                            `;
                            fileElement.dataset.fileName = file.name;

                            // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œé¢„è§ˆæ–‡ä»¶
                            fileElement.querySelector('.file-info').addEventListener('click', () => {
                                previewFile(file.name);
                            });

                            filesList.appendChild(fileElement);
                        });

                        console.log('é‡æ–°æ¸²æŸ“ä¾§è¾¹æ æ–‡ä»¶åˆ—è¡¨æˆåŠŸ');
                    } catch (error) {
                        console.error('é‡æ–°æ¸²æŸ“ä¾§è¾¹æ æ–‡ä»¶åˆ—è¡¨å¤±è´¥ï¼š', error);
                    }
                } else if (folderName === "åˆ†æç»“æœ" && !analysisResultsList.classList.contains('collapsed')) {
                    // é‡æ–°æ¸²æŸ“"åˆ†æç»“æœ"ä¾§è¾¹æ åˆ—è¡¨
                    try {
                        const response = await fetch(`http://localhost:8000/files/${folderName}`, {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });

                        if (!response.ok) throw new Error(`è·å–åˆ†æç»“æœå¤±è´¥ï¼š${response.status}`);

                        const files = await response.json();

                        // æ¸…ç©ºç»“æœåˆ—è¡¨
                        analysisResultsList.innerHTML = '';

                        // æ¸²æŸ“ç»“æœåˆ—è¡¨åˆ°ä¾§è¾¹æ 
                        files.forEach((file, index) => {
                            const fileElement = document.createElement('div');
                            fileElement.className = 'sidebar-file-item';
                            fileElement.innerHTML = `
                                <div class="file-info">
                                    <div class="file-name">${file.name}</div>
                                    <div class="file-desc">å¤§å°ï¼š${file.size}</div>
                                </div>
                                <div class="file-actions">
                                    <button class="action-btn" onclick="toggleFileMenu(event, this, '${file.name}')">
                                        <span class="dots">â€¢â€¢â€¢</span>
                                    </button>
                                </div>
                            `;
                            fileElement.dataset.fileName = file.name;

                            // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œé¢„è§ˆæ–‡ä»¶
                            fileElement.querySelector('.file-info').addEventListener('click', () => {
                                previewFile(file.name);
                            });

                            analysisResultsList.appendChild(fileElement);
                        });

                        console.log('é‡æ–°æ¸²æŸ“ä¾§è¾¹æ åˆ†æç»“æœåˆ—è¡¨æˆåŠŸ');
                    } catch (error) {
                        console.error('é‡æ–°æ¸²æŸ“ä¾§è¾¹æ åˆ†æç»“æœåˆ—è¡¨å¤±è´¥ï¼š', error);
                    }
                }

                console.log('æ–‡ä»¶ä¸Šä¼ åˆ°æ–‡ä»¶å¤¹æˆåŠŸ', result);
            } catch (error) {
                console.error('æ–‡ä»¶ä¸Šä¼ åˆ°æ–‡ä»¶å¤¹å¤±è´¥ï¼š', error);
                createMessage(`æ–‡ä»¶ä¸Šä¼ åˆ°æ–‡ä»¶å¤¹å¤±è´¥ï¼š${error.message}`, 'error');
            }
        }

        // é¢„è§ˆæ–‡ä»¶å†…å®¹
        async function previewFile(fileName) {
            try {
                // è°ƒç”¨æ–‡ä»¶å†…å®¹æ¥å£
                const response = await fetch(`http://localhost:8000/file/${fileName}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`è·å–æ–‡ä»¶å†…å®¹å¤±è´¥ï¼š${response.status}`);
                }

                const fileData = await response.json();

                // æ›´æ–°å³ä¾§æ–‡ä»¶ç»“æœæ æ˜¾ç¤ºæ–‡ä»¶å†…å®¹
                const fileContent = document.getElementById('fileContent');

                // æ ¹æ®æ–‡ä»¶ç±»å‹å’Œå†…å®¹ç±»å‹æ˜¾ç¤ºä¸åŒçš„å†…å®¹
                let contentHTML = '';
                const imageFileTypes = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'svg'];
                const textFileTypes = ['txt', 'csv', 'json', 'xml', 'html', 'css', 'js', 'py', 'md', 'yaml', 'yml', 'ini', 'log', 'conf', 'properties'];

                if (fileData.contentType === 'dataframe') {
                    // æ•°æ®æ–‡ä»¶ï¼Œæ˜¾ç¤ºä¸ºè¡¨æ ¼
                    const columns = fileData.columns;
                    const rows = fileData.rows;
                    const sampleData = fileData.sampleData;

                    // æ„å»ºè¡¨æ ¼HTML
                    let tableHTML = `
                        <table id="dataframe-table" style="width: 100%; border-collapse: collapse; font-size: 14px;">
                            <thead>
                                <tr style="background-color: #f5f5f5;">
                    `;

                    // æ·»åŠ è¡¨å¤´
                    columns.forEach(col => {
                        tableHTML += `
                                    <th style="padding: 8px; border: 1px solid #ddd; text-align: left; font-weight: bold;">${col}</th>
                        `;
                    });

                    tableHTML += `
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    // æ·»åŠ æ•°æ®è¡Œ
                    sampleData.forEach(row => {
                        tableHTML += `
                                <tr style="${sampleData.indexOf(row) % 2 === 1 ? 'background-color: #f9f9f9;' : ''}">
                        `;

                        columns.forEach(col => {
                            let value = row[col] !== null && row[col] !== undefined ? row[col] : '';
                            if (typeof value === 'string' && value.length > 100) {
                                value = value.substring(0, 100) + '...';
                            }
                            tableHTML += `
                                    <td style="padding: 8px; border: 1px solid #ddd; text-align: left; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${value}</td>
                            `;
                        });

                        tableHTML += `
                                </tr>
                        `;
                    });

                    tableHTML += `
                            </tbody>
                        </table>
                    `;

                    contentHTML = `
                        <div style="margin-bottom: 16px;">
                            <div class="file-name" style="font-size: 18px;">${fileData.fileName}</div>
                            <div class="file-desc">æ–‡ä»¶ç±»å‹ï¼š${fileData.fileType}ï¼Œå…± ${rows} è¡Œ ${columns.length} åˆ—</div>
                        </div>
                        <div style="border: 1px solid #eee; border-radius: 6px; padding: 16px; background-color: #f9f9f9; overflow-x: auto;">
                            ${tableHTML}
                        </div>
                        ${rows > 5 ? `<div style="text-align: center; color: #999; margin-top: 8px;">æ˜¾ç¤ºå‰5è¡Œæ•°æ®ï¼Œå…±${rows}è¡Œ</div>` : ''}
                        <div style="text-align: center; margin-top: 16px;">
                            <button onclick="window.open('http://localhost:8000/download/${encodeURIComponent(fileData.fileName)}', '_blank')" style="padding: 8px 16px; background-color: #1890ff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                ä¸‹è½½æ–‡ä»¶
                            </button>
                        </div>
                    `;
                } else if (fileData.contentType === 'base64') {
                    // äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ˜¾ç¤ºä¸‹è½½æç¤º
                    if (imageFileTypes.includes(fileData.fileType)) {
                        // å›¾ç‰‡ç±»å‹ï¼Œç›´æ¥æ˜¾ç¤º
                        contentHTML = `
                            <div style="margin-bottom: 16px;">
                                <div class="file-name" style="font-size: 18px;">${fileData.fileName}</div>
                                <div class="file-desc">æ–‡ä»¶ç±»å‹ï¼š${fileData.fileType}</div>
                            </div>
                            <div style="border: 1px solid #eee; border-radius: 6px; padding: 16px; background-color: #f9f9f9; text-align: center;">
                                <img src="data:image/${fileData.fileType};base64,${fileData.content}" style="max-width: 100%; max-height: 500px; object-fit: contain;" alt="${fileData.fileName}">
                            </div>
                        `;
                    } else {
                        // å…¶ä»–äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ˜¾ç¤ºä¸‹è½½æç¤º
                        contentHTML = `
                            <div style="text-align: center; color: #999; padding: 40px 0;">
                                <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“„</div>
                                <div style="margin-bottom: 16px;">è¿™æ˜¯ä¸€ä¸ª${fileData.fileType}ç±»å‹çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ— æ³•ç›´æ¥é¢„è§ˆ</div>
                                <button onclick="window.open('http://localhost:8000/download/${encodeURIComponent(fileData.fileName)}', '_blank')" style="padding: 8px 16px; background-color: #1890ff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    ä¸‹è½½æ–‡ä»¶
                                </button>
                            </div>
                        `;
                    }
                } else if (fileData.content === `ä¸æ”¯æŒæŸ¥çœ‹${fileData.fileType}ç±»å‹çš„æ–‡ä»¶å†…å®¹`) {
                    // ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹
                    contentHTML = `
                        <div style="text-align: center; color: #999; padding: 40px 0;">
                            <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“„</div>
                            <div>${fileData.content}</div>
                        </div>
                    `;
                } else {
                    // æ–‡æœ¬æ–‡ä»¶ï¼Œç›´æ¥æ˜¾ç¤º
                    contentHTML = `
                        <div style="margin-bottom: 16px;">
                            <div class="file-name" style="font-size: 18px;">${fileData.fileName}</div>
                            <div class="file-desc">æ–‡ä»¶ç±»å‹ï¼š${fileData.fileType}</div>
                        </div>
                        <div style="border: 1px solid #eee; border-radius: 6px; padding: 16px; background-color: #f9f9f9;">
                            <pre style="white-space: pre-wrap; word-wrap: break-word; margin: 0; font-family: monospace;">${fileData.content}</pre>
                        </div>
                    `;
                }

                fileContent.innerHTML = contentHTML;

                console.log('æ–‡ä»¶å†…å®¹è·å–æˆåŠŸ', fileData);
            } catch (error) {
                console.error('è·å–æ–‡ä»¶å†…å®¹å¤±è´¥ï¼š', error);
                createMessage(`è·å–æ–‡ä»¶å†…å®¹å¤±è´¥ï¼š${error.message}`, 'error');
            }
        }

        // åŠ è½½ç‰¹å®šå¯¹è¯çš„å†å²è®°å½•
        async function loadConversationHistory(conversationId) {
            // æ›´æ–°å½“å‰å¯¹è¯ID
            currentConversationId = conversationId;
            saveConversationId(currentConversationId); // æŒä¹…åŒ–åˆ°localStorage

            // æ›´æ–°å†å²å¯¹è¯åˆ—è¡¨çš„æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.history-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.conversationId === conversationId) {
                    item.classList.add('active');
                }
            });

            // åŠ è½½å†å²æ¶ˆæ¯
            await loadHistory(conversationId);
        }

        // å›è½¦å‘é€æ¶ˆæ¯
        document.getElementById('message-input').addEventListener('keydown', function (event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });

        // æ·»åŠ æ–‡ä»¶åˆ°é¢„è§ˆåŒºåŸŸ
        function addFileToPreview(file) {
            // æ·»åŠ åˆ°å¾…å‘é€åˆ—è¡¨
            pendingFiles.push(file);

            // åˆ›å»ºé¢„è§ˆé¡¹
            const previewItem = document.createElement('div');
            previewItem.className = 'message-file';
            previewItem.style.backgroundColor = '#f8f9fa';
            previewItem.style.padding = '8px';
            previewItem.style.borderRadius = '8px';
            previewItem.style.border = '1px solid #e0e0e0';
            previewItem.style.display = 'flex';
            previewItem.style.alignItems = 'center';
            previewItem.style.position = 'relative';
            previewItem.style.maxWidth = '300px';

            // åˆ›å»ºæ–‡ä»¶å›¾æ ‡æˆ–ç¼©ç•¥å›¾
            const fileIcon = document.createElement('div');
            fileIcon.className = 'message-file-icon';
            fileIcon.style.marginRight = '12px';

            // æ£€æŸ¥æ˜¯å¦ä¸ºå›¾ç‰‡æ–‡ä»¶
            if (file.type.startsWith('image/')) {
                // åˆ›å»ºå›¾ç‰‡ç¼©ç•¥å›¾
                const img = document.createElement('img');
                img.style.width = '40px';
                img.style.height = '40px';
                img.style.objectFit = 'cover';
                img.style.borderRadius = '4px';
                img.style.backgroundColor = '#e9ecef';

                // ç”Ÿæˆç¼©ç•¥å›¾
                const reader = new FileReader();
                reader.onload = (e) => {
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);

                fileIcon.appendChild(img);
            } else {
                // ä½¿ç”¨é»˜è®¤æ–‡ä»¶å›¾æ ‡
                fileIcon.textContent = 'ğŸ“„';
                fileIcon.style.fontSize = '24px';
            }

            const fileInfo = document.createElement('div');
            fileInfo.className = 'message-file-info';
            fileInfo.style.flex = 1;
            fileInfo.style.minWidth = '0';

            const fileName = document.createElement('div');
            fileName.className = 'message-file-name';
            fileName.textContent = file.name;
            fileName.style.fontSize = '14px';
            fileName.style.fontWeight = '500';
            fileName.style.marginBottom = '2px';
            fileName.style.overflow = 'hidden';
            fileName.style.textOverflow = 'ellipsis';
            fileName.style.whiteSpace = 'nowrap';

            const fileSize = document.createElement('div');
            fileSize.className = 'message-file-size';
            fileSize.textContent = formatFileSize(file.size);
            fileSize.style.fontSize = '12px';
            fileSize.style.color = '#666';

            fileInfo.appendChild(fileName);
            fileInfo.appendChild(fileSize);

            // æ·»åŠ ç§»é™¤æŒ‰é’®
            const removeBtn = document.createElement('button');
            removeBtn.textContent = 'âœ•';
            removeBtn.style.backgroundColor = 'rgba(0, 0, 0, 0.1)';
            removeBtn.style.border = 'none';
            removeBtn.style.color = '#666';
            removeBtn.style.fontSize = '12px';
            removeBtn.style.cursor = 'pointer';
            removeBtn.style.marginLeft = '8px';
            removeBtn.style.padding = '4px 6px';
            removeBtn.style.borderRadius = '50%';
            removeBtn.style.width = '20px';
            removeBtn.style.height = '20px';
            removeBtn.style.display = 'flex';
            removeBtn.style.alignItems = 'center';
            removeBtn.style.justifyContent = 'center';
            removeBtn.onmouseover = () => {
                removeBtn.style.backgroundColor = 'rgba(0, 0, 0, 0.2)';
            };
            removeBtn.onmouseout = () => {
                removeBtn.style.backgroundColor = 'rgba(0, 0, 0, 0.1)';
            };
            removeBtn.onclick = () => {
                // ä»å¾…å‘é€åˆ—è¡¨ä¸­ç§»é™¤
                pendingFiles = pendingFiles.filter(f => f !== file);
                // ç§»é™¤é¢„è§ˆé¡¹
                previewItem.remove();
                // å¦‚æœæ²¡æœ‰æ–‡ä»¶äº†ï¼Œéšè—é¢„è§ˆåŒºåŸŸå’ŒåŠŸèƒ½æŒ‰é’®
                if (pendingFiles.length === 0) {
                    document.getElementById('file-preview').style.display = 'none';
                    document.getElementById('function-buttons').style.display = 'none';
                }
            };

            previewItem.appendChild(fileIcon);
            previewItem.appendChild(fileInfo);
            previewItem.appendChild(removeBtn);

            // æ·»åŠ åˆ°é¢„è§ˆå®¹å™¨
            document.getElementById('preview-files').appendChild(previewItem);
            // æ˜¾ç¤ºé¢„è§ˆåŒºåŸŸ
            document.getElementById('file-preview').style.display = 'block';
        }

        // æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
        async function uploadFile(files) {
            if (!files || files.length === 0) return;

            const file = files[0];
            // æ·»åŠ åˆ°é¢„è§ˆåŒºåŸŸ
            addFileToPreview(file);
            // æ¸…ç©ºæ–‡ä»¶è¾“å…¥æ¡†
            document.getElementById('file-input').value = '';
        }

        // å®é™…ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨çš„å‡½æ•°
        async function uploadFilesToServer(files) {
            if (!files || files.length === 0) return;

            // å¦‚æœæ²¡æœ‰å½“å‰å¯¹è¯IDï¼Œè‡ªåŠ¨åˆ›å»ºæ–°å¯¹è¯
            if (!currentConversationId) {
                if (!(await createNewConversation())) {
                    createMessage('è¯·å…ˆåˆ›å»ºå¯¹è¯', 'error');
                    return; // å¦‚æœåˆ›å»ºå¯¹è¯å¤±è´¥ï¼Œç»ˆæ­¢ä¸Šä¼ 
                }
            }

            try {
                // åˆ›å»ºFormData
                const formData = new FormData();
                formData.append('content', ''); // ç©ºæ¶ˆæ¯å†…å®¹
                formData.append('source', 'user');
                formData.append('conversationId', currentConversationId);

                // æ·»åŠ æ‰€æœ‰å¾…ä¸Šä¼ çš„æ–‡ä»¶
                for (const file of files) {
                    formData.append('files', file);
                }

                const response = await fetch('http://localhost:8000/chat-with-files', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼š${response.status} ${errorText}`);
                }

                // ä¸Šä¼ æˆåŠŸåï¼Œæ›´æ–°å³ä¾§çš„æ–‡ä»¶ç»“æœæ 
                await loadFolderFiles('æ‰€æœ‰æ–‡ä»¶');

                // å¦‚æœä¾§è¾¹æ çš„"æ‰€æœ‰æ–‡ä»¶"æ˜¯å±•å¼€çŠ¶æ€ï¼Œé‡æ–°æ¸²æŸ“ä¾§è¾¹æ çš„æ–‡ä»¶åˆ—è¡¨
                if (!filesList.classList.contains('collapsed')) {
                    // é‡æ–°æ¸²æŸ“"æ‰€æœ‰æ–‡ä»¶"ä¾§è¾¹æ åˆ—è¡¨
                    try {
                        const defaultFolder = "æ‰€æœ‰æ–‡ä»¶";
                        const response = await fetch(`http://localhost:8000/files/${defaultFolder}`, {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });

                        if (!response.ok) throw new Error(`è·å–æ–‡ä»¶å¤±è´¥ï¼š${response.status}`);

                        const files = await response.json();

                        // æ¸…ç©ºæ–‡ä»¶åˆ—è¡¨
                        filesList.innerHTML = '';

                        // å…ˆæ·»åŠ ä¸Šä¼ æ–‡ä»¶æŒ‰é’®åˆ°ä¾§è¾¹æ æ–‡ä»¶åˆ—è¡¨çš„é¡¶éƒ¨
                        const uploadButton = document.createElement('div');
                        uploadButton.className = 'folder-upload-btn';
                        uploadButton.textContent = 'ä¸Šä¼ æ–‡ä»¶';
                        uploadButton.addEventListener('click', () => {
                            // ç›´æ¥ä¸Šä¼ æ–‡ä»¶åˆ°é»˜è®¤æ–‡ä»¶å¤¹
                            uploadFileToDefaultFolder();
                        });

                        filesList.appendChild(uploadButton);

                        // ç„¶åæ¸²æŸ“æ–‡ä»¶åˆ—è¡¨åˆ°ä¾§è¾¹æ 
                        files.forEach((file, index) => {
                            const fileElement = document.createElement('div');
                            fileElement.className = 'sidebar-file-item';
                            fileElement.innerHTML = `
                                <div class="file-info">
                                    <div class="file-name">${file.name}</div>
                                    <div class="file-desc">å¤§å°ï¼š${file.size}</div>
                                </div>
                                <div class="file-actions">
                                    <button class="action-btn" onclick="toggleFileMenu(event, this, '${file.name}')">
                                        <span class="dots">â€¢â€¢â€¢</span>
                                    </button>
                                </div>
                            `;
                            fileElement.dataset.fileName = file.name;

                            // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œé¢„è§ˆæ–‡ä»¶
                            fileElement.querySelector('.file-info').addEventListener('click', () => {
                                previewFile(file.name);
                            });

                            filesList.appendChild(fileElement);
                        });

                        console.log('é‡æ–°æ¸²æŸ“ä¾§è¾¹æ æ–‡ä»¶åˆ—è¡¨æˆåŠŸ');
                    } catch (error) {
                        console.error('é‡æ–°æ¸²æŸ“ä¾§è¾¹æ æ–‡ä»¶åˆ—è¡¨å¤±è´¥ï¼š', error);
                    }
                }

                console.log('æ–‡ä»¶ä¸Šä¼ æˆåŠŸ');
                return true;
            } catch (error) {
                console.error('æ–‡ä»¶ä¸Šä¼ å¤±è´¥:', error);
                createMessage(`æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼š${error.message}`, 'error');
                return false;
            } finally {
                // æ— è®ºä¸Šä¼ æˆåŠŸä¸å¦ï¼Œéƒ½æ¸…é™¤é¢„è§ˆåŒºåŸŸ
                clearFilePreview();
            }
        }



        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // å½“å‰é€‰ä¸­çš„æ–‡ä»¶åï¼Œç”¨äºå…¨å±€èœå•
        let currentSelectedFile = null;
        // å½“å‰é€‰ä¸­çš„å¯¹è¯IDï¼Œç”¨äºå…¨å±€èœå•
        let currentSelectedConversation = null;

        // åˆ‡æ¢æ–‡ä»¶ä¸‹æ‹‰èœå•çš„æ˜¾ç¤º/éšè—
        function toggleFileMenu(event, button, fileName) {
            // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé˜²æ­¢è§¦å‘æ–‡ä»¶é¢„è§ˆ
            event.stopPropagation();

            // è·å–å…¨å±€èœå•å®¹å™¨
            const globalMenu = document.getElementById('global-file-menu');

            // å…³é—­èœå•å¦‚æœå·²ç»æ‰“å¼€
            if (globalMenu.classList.contains('show') && currentSelectedFile === fileName) {
                globalMenu.classList.remove('show');
                currentSelectedFile = null;
                return;
            }

            // æ›´æ–°å½“å‰é€‰ä¸­çš„æ–‡ä»¶
            currentSelectedFile = fileName;

            // è·å–æŒ‰é’®ä½ç½®
            const rect = button.getBoundingClientRect();
            const menuHeight = 36; // èœå•ä¼°è®¡é«˜åº¦ï¼ˆä¸€ä¸ªèœå•é¡¹ï¼‰
            const viewportHeight = window.innerHeight;

            // è®¾ç½®èœå•ä½ç½®ä¸ºå›ºå®šå®šä½ï¼Œç›¸å¯¹äºè§†å£
            globalMenu.style.position = 'fixed';
            globalMenu.style.right = (window.innerWidth - rect.right) + 'px';

            // æ™ºèƒ½å®šä½ï¼šæ£€æŸ¥ä¸‹æ–¹ç©ºé—´æ˜¯å¦è¶³å¤Ÿ
            const spaceBelow = viewportHeight - rect.bottom;

            if (spaceBelow >= menuHeight) {
                // ä¸‹æ–¹ç©ºé—´è¶³å¤Ÿï¼Œæ˜¾ç¤ºåœ¨æŒ‰é’®ä¸‹æ–¹
                globalMenu.style.top = rect.bottom + 4 + 'px';
            } else {
                // ä¸‹æ–¹ç©ºé—´ä¸è¶³ï¼Œæ˜¾ç¤ºåœ¨æŒ‰é’®ä¸Šæ–¹
                globalMenu.style.top = (rect.top - menuHeight - 4) + 'px';
            }

            // æ˜¾ç¤ºèœå•
            globalMenu.classList.add('show');
        }

        // åˆ‡æ¢å¯¹è¯ä¸‹æ‹‰èœå•çš„æ˜¾ç¤º/éšè—
        function toggleConversationMenu(event, button, conversationId) {
            // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé˜²æ­¢è§¦å‘å¯¹è¯åŠ è½½
            event.stopPropagation();
            event.preventDefault();

            // ç¡®ä¿èœå•å®¹å™¨å·²åˆ›å»º
            let globalMenu = document.getElementById('global-conversation-menu');
            if (!globalMenu) {
                // å¦‚æœèœå•å®¹å™¨ä¸å­˜åœ¨ï¼Œç«‹å³åˆ›å»º
                const globalMenuContainer = document.createElement('div');
                globalMenuContainer.id = 'global-conversation-menu';
                globalMenuContainer.className = 'file-menu';
                globalMenuContainer.innerHTML = `<div class="menu-item" onclick="deleteConversationFromMenu()">åˆ é™¤</div>`;
                document.body.appendChild(globalMenuContainer);
                globalMenu = globalMenuContainer;
            }

            // å…³é—­èœå•å¦‚æœå·²ç»æ‰“å¼€
            if (globalMenu.classList.contains('show') && currentSelectedConversation === conversationId) {
                globalMenu.classList.remove('show');
                currentSelectedConversation = null;
                return;
            }

            // å…ˆå…³é—­æ‰€æœ‰èœå•
            const fileMenu = document.getElementById('global-file-menu');
            if (fileMenu) fileMenu.classList.remove('show');
            currentSelectedFile = null;

            // æ›´æ–°å½“å‰é€‰ä¸­çš„å¯¹è¯
            currentSelectedConversation = conversationId;

            // è·å–æŒ‰é’®ä½ç½®
            const rect = button.getBoundingClientRect();
            const menuHeight = 36; // èœå•ä¼°è®¡é«˜åº¦ï¼ˆä¸€ä¸ªèœå•é¡¹ï¼‰
            const viewportHeight = window.innerHeight;

            // è®¾ç½®èœå•ä½ç½®ä¸ºå›ºå®šå®šä½ï¼Œç›¸å¯¹äºè§†å£
            globalMenu.style.position = 'fixed';
            globalMenu.style.right = (window.innerWidth - rect.right) + 'px';

            // æ™ºèƒ½å®šä½ï¼šæ£€æŸ¥ä¸‹æ–¹ç©ºé—´æ˜¯å¦è¶³å¤Ÿ
            const spaceBelow = viewportHeight - rect.bottom;

            if (spaceBelow >= menuHeight) {
                // ä¸‹æ–¹ç©ºé—´è¶³å¤Ÿï¼Œæ˜¾ç¤ºåœ¨æŒ‰é’®ä¸‹æ–¹
                globalMenu.style.top = rect.bottom + 4 + 'px';
            } else {
                // ä¸‹æ–¹ç©ºé—´ä¸è¶³ï¼Œæ˜¾ç¤ºåœ¨æŒ‰é’®ä¸Šæ–¹
                globalMenu.style.top = (rect.top - menuHeight - 4) + 'px';
            }

            // æ˜¾ç¤ºèœå•
            globalMenu.classList.add('show');
            console.log('å¯¹è¯èœå•å·²æ˜¾ç¤º', globalMenu);
        }

        // ä»å…¨å±€èœå•ä¸‹è½½æ–‡ä»¶
        function downloadFileFromMenu() {
            if (currentSelectedFile) {
                // æ„é€ ä¸‹è½½URL
                const downloadUrl = `http://localhost:8000/download/${currentSelectedFile}?folder_name=æ‰€æœ‰æ–‡ä»¶`;

                // åˆ›å»ºä¸€ä¸ªä¸´æ—¶é“¾æ¥å¹¶ç‚¹å‡»ä¸‹è½½
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = currentSelectedFile;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                // å…³é—­èœå•
                const globalMenu = document.getElementById('global-file-menu');
                globalMenu.classList.remove('show');
                currentSelectedFile = null;
            }
        }

        // åŸæ¥çš„ä¸‹è½½æ–‡ä»¶åŠŸèƒ½ï¼ˆä¿ç•™ç”¨äºå…¶ä»–åœ°æ–¹è°ƒç”¨ï¼‰
        function downloadFile(fileName) {
            // æ„é€ ä¸‹è½½URL
            const downloadUrl = `http://localhost:8000/download/${fileName}?folder_name=æ‰€æœ‰æ–‡ä»¶`;

            // åˆ›å»ºä¸€ä¸ªä¸´æ—¶é“¾æ¥å¹¶ç‚¹å‡»ä¸‹è½½
            const link = document.createElement('a');
            link.href = downloadUrl;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            // å…³é—­èœå•
            const globalMenu = document.getElementById('global-file-menu');
            globalMenu.classList.remove('show');
            currentSelectedFile = null;
        }

        // ä»å…¨å±€èœå•åˆ é™¤å¯¹è¯
        function deleteConversationFromMenu() {
            if (currentSelectedConversation) {
                deleteConversation(currentSelectedConversation);
            }
            // å…³é—­èœå•
            const globalMenu = document.getElementById('global-conversation-menu');
            if (globalMenu) {
                globalMenu.classList.remove('show');
                currentSelectedConversation = null;
            }
        }

        // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­æ‰€æœ‰èœå•
        document.addEventListener('click', (event) => {
            if (!event.target.closest('.file-actions') && !event.target.closest('.file-menu')) {
                // å…³é—­æ–‡ä»¶èœå•
                const globalFileMenu = document.getElementById('global-file-menu');
                if (globalFileMenu) {
                    globalFileMenu.classList.remove('show');
                    currentSelectedFile = null;
                }

                // å…³é—­å¯¹è¯èœå•
                const globalConversationMenu = document.getElementById('global-conversation-menu');
                if (globalConversationMenu) {
                    globalConversationMenu.classList.remove('show');
                    currentSelectedConversation = null;
                }
            }
        });

        // åˆ é™¤å¯¹è¯
        async function deleteConversation(conversationId) {
            // ç¡®è®¤åˆ é™¤
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¯¹è¯å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                return;
            }

            try {
                const response = await fetch(`http://localhost:8000/conversation/${conversationId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`åˆ é™¤å¯¹è¯å¤±è´¥ï¼š${response.status}`);
                }

                const result = await response.json();

                // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰å¯¹è¯ï¼Œåˆ›å»ºæ–°å¯¹è¯
                if (conversationId === currentConversationId) {
                    // åˆ›å»ºæ–°å¯¹è¯
                    const newResponse = await fetch('http://localhost:8000/new-conversation', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!newResponse.ok) throw new Error(`æ–°å¢å¯¹è¯å¤±è´¥ï¼š${newResponse.status}`);

                    const newResult = await newResponse.json();
                    currentConversationId = newResult.conversationId;
                    saveConversationId(currentConversationId);

                    // æ¸…ç©ºå½“å‰èŠå¤©è®°å½•
                    messagesContainer.innerHTML = '';
                    createMessage(`å·²åˆ›å»ºæ–°å¯¹è¯ï¼ˆIDï¼š${currentConversationId}ï¼‰`, 'system');
                }

                // é‡æ–°åŠ è½½å†å²å¯¹è¯åˆ—è¡¨
                const historyChatItem = document.getElementById('historyChatItem');
                if (!historyChatItem.classList.contains('expanded')) {
                    historyChatItem.click();
                } else {
                    // å¦‚æœå·²ç»å±•å¼€ï¼Œé‡æ–°è·å–å†å²å¯¹è¯åˆ—è¡¨
                    const response = await fetch('http://localhost:8000/history-conversations', {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) throw new Error(`è·å–å†å²å¯¹è¯å¤±è´¥ï¼š${response.status}`);

                    const historyConversations = await response.json();
                    const historyList = document.getElementById('historyList');
                    historyList.innerHTML = '';

                    // é‡æ–°æ¸²æŸ“å†å²å¯¹è¯åˆ—è¡¨
                    historyConversations.forEach((conv, index) => {
                        const historyItemContainer = document.createElement('div');
                        historyItemContainer.style.display = 'flex';
                        historyItemContainer.style.alignItems = 'center';

                        const historyItem = document.createElement('div');
                        historyItem.className = `history-item ${currentConversationId === conv.conversationId ? 'active' : ''}`;
                        historyItem.textContent = `å¯¹è¯ ${index + 1}`;
                        historyItem.dataset.conversationId = conv.conversationId;
                        historyItem.style.flex = '1';

                        // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼ŒåŠ è½½å¯¹åº”å¯¹è¯çš„å†å²è®°å½•
                        historyItem.addEventListener('click', () => {
                            loadConversationHistory(conv.conversationId);
                        });

                        // æ·»åŠ åˆ é™¤æŒ‰é’®
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'delete-conversation-btn';
                        deleteBtn.textContent = 'Ã—';
                        deleteBtn.style.width = '24px';
                        deleteBtn.style.height = '24px';
                        deleteBtn.style.border = 'none';
                        deleteBtn.style.borderRadius = '50%';
                        deleteBtn.style.backgroundColor = '#e74c3c';
                        deleteBtn.style.color = 'white';
                        deleteBtn.style.cursor = 'pointer';
                        deleteBtn.style.fontSize = '14px';
                        deleteBtn.style.display = 'flex';
                        deleteBtn.style.alignItems = 'center';
                        deleteBtn.style.justifyContent = 'center';
                        deleteBtn.style.marginRight = '8px';
                        deleteBtn.style.opacity = '0.7';
                        deleteBtn.style.transition = 'opacity 0.2s';
                        deleteBtn.title = 'åˆ é™¤å¯¹è¯';

                        // é¼ æ ‡æ‚¬åœæ•ˆæœ
                        deleteBtn.addEventListener('mouseenter', () => {
                            deleteBtn.style.opacity = '1';
                        });
                        deleteBtn.addEventListener('mouseleave', () => {
                            deleteBtn.style.opacity = '0.7';
                        });

                        // åˆ é™¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                        deleteBtn.addEventListener('click', (e) => {
                            e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
                            deleteConversation(conv.conversationId);
                        });

                        historyItemContainer.appendChild(deleteBtn);
                        historyItemContainer.appendChild(historyItem);
                        historyList.appendChild(historyItemContainer);
                    });
                }

                console.log('åˆ é™¤å¯¹è¯æˆåŠŸ', result);
            } catch (error) {
                console.error('åˆ é™¤å¯¹è¯å¤±è´¥ï¼š', error);
                createMessage(`åˆ é™¤å¯¹è¯å¤±è´¥ï¼š${error.message}`, 'error');
            }
        }

        // æ¸…ç©ºèŠå¤©è®°å½•
        async function clearChatHistory() {
            // ç¡®è®¤æ¸…ç©º
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºå½“å‰èŠå¤©è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                return;
            }

            try {
                const response = await fetch('http://localhost:8000/clear-chat-history', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: `conversationId=${currentConversationId}`
                });

                if (!response.ok) {
                    throw new Error(`æ¸…ç©ºèŠå¤©è®°å½•å¤±è´¥ï¼š${response.status}`);
                }

                const result = await response.json();

                // æ¸…ç©ºå½“å‰èŠå¤©è®°å½•
                messagesContainer.innerHTML = '';
                createMessage('èŠå¤©è®°å½•å·²æ¸…ç©º', 'system');

                console.log('æ¸…ç©ºèŠå¤©è®°å½•æˆåŠŸ', result);
            } catch (error) {
                console.error('æ¸…ç©ºèŠå¤©è®°å½•å¤±è´¥ï¼š', error);
                createMessage(`æ¸…ç©ºèŠå¤©è®°å½•å¤±è´¥ï¼š${error.message}`, 'error');
            }
        }

        // å‘é€æ¶ˆæ¯ç›¸å…³å…¨å±€å˜é‡
        let abortController = null;
        let isSending = false;

        // å–æ¶ˆè¯·æ±‚å‡½æ•°
        function cancelRequest() {
            if (isSending && abortController) {
                // å–æ¶ˆå½“å‰è¯·æ±‚
                abortController.abort();
                console.log('è¯·æ±‚å·²å–æ¶ˆ');
            }
        }

        // å‘é€æ¶ˆæ¯å‡½æ•°
        async function sendMessage() {
            const input = document.getElementById('message-input');
            const button = document.getElementById('send-button'); // ä½¿ç”¨IDé€‰æ‹©å™¨æœ€å¯é 
            const message = input.value.trim();

            // æ£€æŸ¥æ˜¯å¦æœ‰æ¶ˆæ¯æˆ–æ–‡ä»¶éœ€è¦å‘é€
            if (!message && pendingFiles.length === 0) return;

            // å¦‚æœæ²¡æœ‰å½“å‰å¯¹è¯IDï¼Œè‡ªåŠ¨åˆ›å»ºæ–°å¯¹è¯
            if (!currentConversationId) {
                if (!(await createNewConversation())) {
                    return; // å¦‚æœåˆ›å»ºå¯¹è¯å¤±è´¥ï¼Œç»ˆæ­¢å‘é€
                }
            }

            // ç¡®ä¿æ‰¾åˆ°æŒ‰é’®
            if (button) {
                console.log('æ‰¾åˆ°å‘é€æŒ‰é’®:', button);
                // åˆ‡æ¢æŒ‰é’®ä¸ºç»ˆæ­¢çŠ¶æ€
                isSending = true;
                button.onclick = cancelRequest;
                button.textContent = 'â—‰';
                button.innerHTML = 'â—‰'; // ç¡®ä¿æŒ‰é’®å†…å®¹è¢«æ›´æ–°
                button.title = 'ç»ˆæ­¢è¯·æ±‚';
                console.log('æŒ‰é’®çŠ¶æ€å·²æ›´æ–°:', button.textContent, button.onclick);
            } else {
                console.error('æ‰¾ä¸åˆ°å‘é€æŒ‰é’®');
                // å°è¯•ä¸åŒçš„é€‰æ‹©å™¨
                const allButtons = document.querySelectorAll('#input-container button');
                console.log('æ‰€æœ‰æŒ‰é’®:', allButtons);
            }

            // å±•ç¤ºç”¨æˆ·æ¶ˆæ¯ï¼ˆä»…å‰ç«¯å±•ç¤ºï¼Œåç«¯è‡ªè¡Œå­˜å‚¨ï¼‰
            const messageWrapper = createMessage(message, 'user');
            const messageContent = messageWrapper.querySelector('.message');

            // å¦‚æœæœ‰å¾…å‘é€çš„æ–‡ä»¶ï¼Œåœ¨æ¶ˆæ¯ä¸­æ˜¾ç¤º
            if (pendingFiles.length > 0) {
                for (const file of pendingFiles) {
                    const fileMessage = document.createElement('div');
                    fileMessage.className = 'message-file';
                    fileMessage.style.marginTop = '8px';

                    const fileIcon = document.createElement('div');
                    fileIcon.className = 'message-file-icon';
                    fileIcon.textContent = 'ğŸ“„';

                    const fileInfo = document.createElement('div');
                    fileInfo.className = 'message-file-info';

                    const fileName = document.createElement('div');
                    fileName.className = 'message-file-name';
                    fileName.textContent = file.name;

                    const fileSize = document.createElement('div');
                    fileSize.className = 'message-file-size';
                    fileSize.textContent = formatFileSize(file.size);

                    fileInfo.appendChild(fileName);
                    fileInfo.appendChild(fileSize);

                    fileMessage.appendChild(fileIcon);
                    fileMessage.appendChild(fileInfo);
                    messageContent.appendChild(fileMessage);
                }
            }

            input.value = '';

            // å¤åˆ¶å¾…å‘é€çš„æ–‡ä»¶åˆ—è¡¨ï¼ˆç”¨äºAPIè°ƒç”¨ï¼‰
            const filesToSend = [...pendingFiles];

            // æ¸…ç©ºé¢„è§ˆåŒºåŸŸå’Œå¾…å‘é€åˆ—è¡¨ï¼ˆç‚¹å‡»å‘é€åç«‹å³å…³é—­ï¼‰
            document.getElementById('preview-files').innerHTML = '';
            document.getElementById('file-preview').style.display = 'none';
            pendingFiles = [];

            input.disabled = true;

            try {
                // åˆ›å»ºä¸­æ­¢æ§åˆ¶å™¨
                abortController = new AbortController();

                // å¦‚æœæœ‰å¾…å‘é€çš„æ–‡ä»¶ï¼Œä½¿ç”¨FormDataå‘é€
                if (filesToSend.length > 0) {
                    console.log('å‘é€æ–‡ä»¶è¯·æ±‚ï¼ŒconversationId:', currentConversationId, 'message:', message, 'files:', filesToSend);

                    const formData = new FormData();
                    formData.append('content', message);
                    formData.append('source', 'user');
                    formData.append('conversationId', currentConversationId);

                    // æ·»åŠ æ‰€æœ‰å¾…å‘é€çš„æ–‡ä»¶
                    for (const file of filesToSend) {
                        formData.append('files', file);
                    }

                    // è°ƒè¯•FormDataå†…å®¹
                    for (const pair of formData.entries()) {
                        console.log('FormData entry:', pair[0], pair[0] === 'files' ? pair[1].name : pair[1]);
                    }

                    // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦æç¤º
                    const uploadProgress = createMessage('æ­£åœ¨å¤„ç†æ–‡ä»¶...', 'system');

                    const response = await fetch('http://localhost:8000/chat-with-files', {
                        method: 'POST',
                        body: formData,
                        signal: abortController.signal
                    });

                    // ç§»é™¤ä¸Šä¼ è¿›åº¦æç¤º
                    uploadProgress.remove();

                    if (!response.ok) {
                        throw new Error(`HTTPé”™è¯¯ï¼š${response.status}`);
                    }

                    // åˆ›å»ºåŠ©æ‰‹æ¶ˆæ¯å®¹å™¨
                    currentAssistantMessage = createMessage('', 'assistant');
                    const contentElement = currentAssistantMessage.querySelector('.message');

                    // æµå¼è¯»å–å¹¶è¿½åŠ åˆ°åŒä¸€ä¸ªå®¹å™¨
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder('utf-8');

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) {
                            console.log('æµå¼å“åº”å®Œæˆ');
                            currentAssistantMessage = null;
                            break;
                        }
                        const chunk = decoder.decode(value, { stream: true });
                        contentElement.textContent += chunk;
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }
                } else {
                    // åªæœ‰æ–‡æœ¬æ¶ˆæ¯ï¼Œä½¿ç”¨åŸæ¥çš„JSONæ ¼å¼å‘é€
                    const response = await fetch('http://localhost:8000/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            content: message,
                            source: 'user',
                            conversationId: currentConversationId
                        }),
                        signal: abortController.signal
                    });

                    if (!response.ok) {
                        throw new Error(`HTTPé”™è¯¯ï¼š${response.status}`);
                    }

                    // åˆ›å»ºåŠ©æ‰‹æ¶ˆæ¯å®¹å™¨
                    currentAssistantMessage = createMessage('', 'assistant');
                    const contentElement = currentAssistantMessage.querySelector('.message');

                    // æµå¼è¯»å–å¹¶è¿½åŠ åˆ°åŒä¸€ä¸ªå®¹å™¨
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder('utf-8');

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) {
                            console.log('æµå¼å“åº”å®Œæˆ');
                            currentAssistantMessage = null;
                            break;
                        }
                        const chunk = decoder.decode(value, { stream: true });
                        contentElement.textContent += chunk;
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }
                }

            } catch (error) {
                console.error('è¯·æ±‚å¤±è´¥ï¼š', error);

                // å¤„ç†å–æ¶ˆè¯·æ±‚çš„æƒ…å†µ
                if (error.name === 'AbortError') {
                    createMessage('è¯·æ±‚å·²å–æ¶ˆ', 'system');
                } else {
                    createMessage(`è¯·æ±‚å¤±è´¥ï¼š${error.message}`, 'error');
                }

                currentAssistantMessage = null;
            } finally {
                input.disabled = false;

                // æ¢å¤å‘é€æŒ‰é’®çŠ¶æ€
                const button = document.getElementById('send-button');
                if (button) {
                    isSending = false;
                    button.onclick = sendMessage;
                    button.textContent = 'â†‘';
                    button.innerHTML = 'â†‘'; // ç¡®ä¿æŒ‰é’®å†…å®¹è¢«æ›´æ–°
                    button.title = 'å‘é€';
                    console.log('æŒ‰é’®å·²æ¢å¤ä¸ºå‘é€çŠ¶æ€');
                }

                input.focus();

                // é¢„è§ˆåŒºåŸŸå’Œå¾…å‘é€åˆ—è¡¨å·²åœ¨å‘é€æ—¶æ¸…ç©º

                // é‡ç½®ä¸­æ­¢æ§åˆ¶å™¨
                abortController = null;
            }
        }

        // æ ¸å¿ƒï¼šåˆ›å»ºå•ä¸ªæ¶ˆæ¯å®¹å™¨ï¼ˆå«å¤´åƒ+å†…å®¹ï¼‰
        function createMessage(content, source) {
            const wrapper = document.createElement('div');
            wrapper.className = `message-wrapper ${source}`;

            // å¤´åƒ
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';

            // å†…å®¹
            const contentElement = document.createElement('div');
            contentElement.className = 'message';
            contentElement.textContent = content;

            wrapper.appendChild(avatar);
            wrapper.appendChild(contentElement);
            messagesContainer.appendChild(wrapper);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            return wrapper;
        }

        // ä¼˜åŒ–ï¼šåŠ è½½å†å²æ¶ˆæ¯ï¼ˆä»…è¯»å–åç«¯/historyæ¥å£ï¼Œä¸ä¸»åŠ¨ä¿å­˜ï¼‰
        async function loadHistory(conversationId = null) {
            // æ¸…ç©ºç°æœ‰æ¶ˆæ¯ï¼ˆé¿å…é‡å¤åŠ è½½ï¼‰
            messagesContainer.innerHTML = '';

            try {
                // æ„å»ºè¯·æ±‚URL
                let url = 'http://localhost:8000/history';
                if (conversationId) {
                    url += `?conversationId=${conversationId}`;
                }

                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    // åŒºåˆ†ä¸åŒé”™è¯¯ç±»å‹
                    if (response.status === 404) {
                        throw new Error('åŠ è½½å†å²å¤±è´¥ï¼šå†å²æ¥å£æœªæ‰¾åˆ°ï¼Œè¯·æ£€æŸ¥åç«¯æ˜¯å¦å¯åŠ¨');
                    } else if (response.status === 500) {
                        const errorData = await response.json().catch(() => ({ detail: 'æœªçŸ¥æœåŠ¡å™¨é”™è¯¯' }));
                        throw new Error(`åŠ è½½å†å²å¤±è´¥ï¼š${errorData.detail}`);
                    } else {
                        throw new Error(`åŠ è½½å†å²å¤±è´¥ï¼šç½‘ç»œå¼‚å¸¸ï¼ˆçŠ¶æ€ç ï¼š${response.status}ï¼‰`);
                    }
                }

                const history = await response.json();
                if (Array.isArray(history) && history.length > 0) {
                    // æŒ‰é¡ºåºæ¸²æŸ“å†å²æ¶ˆæ¯
                    history.forEach(message => {
                        if (typeof message === 'object' && message.content && message.source) {
                            createMessage(message.content, message.source);
                        }
                    });
                } else {
                    createMessage('æš‚æ— èŠå¤©å†å²', 'system');
                }
            } catch (error) {
                console.error('åŠ è½½å†å²å¤±è´¥ï¼š', error);
                // å‹å¥½æç¤ºç”¨æˆ·
                if (error.message.includes('Failed to fetch')) {
                    createMessage('æ— æ³•è¿æ¥åˆ°èŠå¤©æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥åç«¯æ˜¯å¦å¯åŠ¨', 'system');
                } else {
                    createMessage(`åŠ è½½å†å²å¤±è´¥ï¼š${error.message}`, 'system');
                }
            }
        }

        // ä¼šè¯æŒä¹…åŒ–å·¥å…·å‡½æ•°
        function saveConversationId(conversationId) {
            try {
                localStorage.setItem('currentConversationId', conversationId);
            } catch (error) {
                console.error('æ— æ³•ä¿å­˜ä¼šè¯IDåˆ°localStorage:', error);
            }
        }

        function loadConversationId() {
            try {
                return localStorage.getItem('currentConversationId');
            } catch (error) {
                console.error('æ— æ³•ä»localStorageåŠ è½½ä¼šè¯ID:', error);
                return null;
            }
        }

        // åˆ›å»ºæ–°å¯¹è¯çš„è¾…åŠ©å‡½æ•°
        async function createNewConversation() {
            try {
                const response = await fetch('http://localhost:8000/new-conversation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`æ–°å¢å¯¹è¯å¤±è´¥ï¼š${response.status}`);
                }

                const result = await response.json();
                currentConversationId = result.conversationId; // ä¿å­˜æ–°å¯¹è¯ID
                saveConversationId(currentConversationId); // æŒä¹…åŒ–åˆ°localStorage

                // æ¸…ç©ºå½“å‰èŠå¤©è®°å½•ï¼Œæ˜¾ç¤ºç³»ç»Ÿæç¤º
                messagesContainer.innerHTML = '';
                createMessage(`å·²åˆ›å»ºæ–°å¯¹è¯ï¼ˆIDï¼š${currentConversationId}ï¼‰`, 'system');

                console.log('æ–°å¯¹è¯åˆ›å»ºæˆåŠŸ:', currentConversationId);
                return currentConversationId;
            } catch (error) {
                console.error('åˆ›å»ºæ–°å¯¹è¯å¤±è´¥:', error);
                createMessage(`åˆ›å»ºæ–°å¯¹è¯å¤±è´¥ï¼š${error.message}`, 'error');
                return null;
            }
        }

        // ç¡®ä¿é¡µé¢å®Œå…¨åŠ è½½åæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', async () => {
            // ä»localStorageåŠ è½½å½“å‰å¯¹è¯ID
            let savedConversationId = loadConversationId();

            if (savedConversationId) {
                try {
                    // å°è¯•è·å–å¯¹è¯ä¿¡æ¯ä»¥éªŒè¯å…¶æœ‰æ•ˆæ€§
                    const response = await fetch(`http://localhost:8000/conversation/${savedConversationId}`, {
                        method: 'GET'
                    });

                    if (response.ok) {
                        currentConversationId = savedConversationId;
                        try {
                            await loadHistory(currentConversationId);
                        } catch (error) {
                            console.error('åŠ è½½å†å²æ¶ˆæ¯å¤±è´¥:', error);
                            // åŠ è½½å†å²å¤±è´¥ä½†å¯¹è¯IDæœ‰æ•ˆï¼Œä¸åˆ›å»ºæ–°å¯¹è¯
                        }
                    } else {
                        console.warn('ä¿å­˜çš„å¯¹è¯IDæ— æ•ˆï¼Œæ¸…é™¤è¯¥ID');
                        localStorage.removeItem('currentConversationId');
                        currentConversationId = null;
                    }
                } catch (error) {
                    console.error('éªŒè¯å¯¹è¯IDå¤±è´¥:', error);
                    // éªŒè¯å¤±è´¥ï¼Œä¸åˆ›å»ºæ–°å¯¹è¯
                    currentConversationId = null;
                }
            } else {
                // æ²¡æœ‰ä¿å­˜çš„å¯¹è¯IDï¼Œä¸è‡ªåŠ¨åˆ›å»ºæ–°å¯¹è¯
                currentConversationId = null;
            }
        });
    </script>
</body>
</html>